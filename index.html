<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JS - Sort Midi</title>
    <style>
        .outer {
            width: 90%;
            margin: auto;
        }

        .bars {
            text-align: center;
        }

        .bar {
            background-color: hsl(0, 33%, 19%);
            display: inline-block;
            margin: 1px;
        }

        .console {
            width: 1440px;
            height: 300px;
        }
    </style>
</head>
<body>

<button id="bubblesortbutton">BubbleSort</button>
<button id="mixbutton">mix</button>

<div class="outer">
    <div id="bars" class="bars"></div>
    <textarea id="console" class="console"></textarea>
</div>


<!-- https://medium.com/swinginc/playing-with-midi-in-javascript-b6999f2913c3 -->
<!-- https://medium.com/techtrument/multithreading-javascript-46156179cf9a -->

<script type="module">

    import Sort from './sort/sorting/Sort.js';

    let numbers = [...Array(140).keys()]
    let barsMixed = false;


    async function printBars(el, arr) {
        const container = document.getElementById(el)

        container.innerHTML = ""

        for (let n = 0; n < arr.length; n++) {
            let bar = document.createElement("div")
            bar.style.width = 720 / arr.length + "px"
            bar.style.height = arr[n] + 5 + "px";
            bar.style.backgroundColor = "hsl(" + arr[n] + ",100%,50%)";
            bar.id = el + "-" + arr[n]
            bar.setAttribute('class', 'bar')
            container.append(bar)
        }
    }

    async function mixBars(arr) {
        arr = arr.sort(() => Math.random() - 0.5)
        printBars("bars", arr)
    }

    class BubbleSort extends Sort {


        async sort(originalArray) {
            // Flag that holds info about whether the swap has occur or not.
            let swapped = false;
            // Clone original array to prevent its modification.
            const array = [...originalArray];

            for (let i = 1; i < array.length; i += 1) {

                    swapped = false;

                    // Call visiting callback.
                    this.callbacks.visitingCallback(array[i]);

                    for (let j = 0; j < array.length - i; j += 1) {

                            // Call visiting callback.
                            this.callbacks.visitingCallback(array[j]);

                            // Swap elements if they are in wrong order.
                            if (this.comparator.lessThan(array[j + 1], array[j])) {
                                [array[j], array[j + 1]] = [array[j + 1], array[j]];

                                let txtarr = document.getElementById("console")

                                txtarr.value += "swapped " + array[j] + " with " + array[j + 1] + "\n"

                                // make animated
                                let oldelem = document.getElementById("bars-" + array[j])
                                let newelem = document.getElementById("bars-" + array[j + 1])

                                console.log(oldelem.id)
                                newelem.parentNode.insertBefore(oldelem, newelem.parentNode.firstChild)
                                oldelem.parentNode.insertBefore(newelem, oldelem.parentNode.firstChild)

                                // Register the swap.
                                swapped = true;
                            }

                    }

                    // If there were no swaps then array is already sorted and there is
                    // no need to proceed.
                    if (!swapped) {
                        printBars("bars", array)
                        return array;
                    }
                    printBars("bars", array)



            }

            return array;
        }
    }


    let bubblesortbutton = document.getElementById("bubblesortbutton")
    let mixbutton = document.getElementById("mixbutton")

    function checkButtons(barsMixed, mixbutton, buttons) {

        console.log(typeof buttons)

        if (barsMixed) {
            mixbutton.disabled = true


            buttons.forEach((b) => {
                console.log(b.id)
                b.disabled = false
            })

        } else {
            mixbutton.disabled = false
            buttons.forEach((b) => {
                console.log(b.id)
                b.disabled = true
            })
        }

    }


    bubblesortbutton.addEventListener('click', (e) => {
        let bs = new BubbleSort().sort(numbers)
        console.log(bs)
        barsMixed = false
        checkButtons(barsMixed, mixbutton, [bubblesortbutton])
    })

    mixbutton.addEventListener('click', (e) => {
        barsMixed = true
        checkButtons(barsMixed, mixbutton, [bubblesortbutton])
        mixBars(numbers)
    })


    printBars("bars", numbers)
    checkButtons(barsMixed, mixbutton, [bubblesortbutton])

</script>
</body>
</html>