<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JS - Sort Midi</title>
    <style>
        .outer {
            width: 90%;
            margin: auto;
        }

        .bars {
            text-align: center;
        }

        .bar {
            background-color: hsl(0, 33%, 19%);
            display: inline-block;
            margin: 1px;
        }

        .console {
            width: 1440px;
            height: 300px;
        }
    </style>
</head>
<body>

<button id="bubblesortbutton">BubbleSort</button>
<button id="mixbutton">mix</button>
<button id="stopbutton">stop</button>

<div class="outer">
    <div id="bars" class="bars"></div>
    <textarea id="console" class="console"></textarea>
</div>


<!-- https://medium.com/swinginc/playing-with-midi-in-javascript-b6999f2913c3 -->
<!-- https://medium.com/techtrument/multithreading-javascript-46156179cf9a -->

<script type="module">


    let numbers = [...Array(120).keys()]
    let barsMixed = false;

    var worker = new Worker("bubble.js")


    async function printBars(el, arr) {
        const container = document.getElementById(el)

        container.innerHTML = ""


        for (let n = 0; n < arr.length; n++) {
            let bar = document.createElement("div")
            bar.style.width = 720 / arr.length + "px"
            bar.style.height = arr[n] + 5 + "px";
            bar.style.backgroundColor = "hsl(" + arr[n] + ",100%,50%)";
            bar.id = el + "-" + arr[n]
            bar.setAttribute('class', 'bar')
            container.append(bar)
        }
    }

    async function mixBars(arr) {
        arr = arr.sort(() => Math.random() - 0.5)
        printBars("bars", arr)
    }


    let bubblesortbutton = document.getElementById("bubblesortbutton")
    let mixbutton = document.getElementById("mixbutton")
    let stopbutton = document.getElementById("stopbutton")

    function checkButtons(barsMixed, mixbutton, buttons) {
        if (barsMixed) {
            mixbutton.disabled = true
            buttons.forEach((b) => {
                b.disabled = false
            })

        } else {
            mixbutton.disabled = false
            buttons.forEach((b) => {
                b.disabled = true
            })
            document.getElementById("console").value = ""
        }

    }

    function workerFunction(e) {

    }

    worker.addEventListener('message', function (e) {
        //console.log(e.data);
        printBars("bars", e.data.array)
        let console = document.getElementById("console")

        if(e.data.finished){
            console.value += ""
        }


        console.value += e.data.swap
        console.scrollTop = console.scrollHeight;


    })

    bubblesortbutton.addEventListener('click', (e) => {
        worker.postMessage(numbers)
        barsMixed = false
        checkButtons(barsMixed, mixbutton, [bubblesortbutton])
    })

    mixbutton.addEventListener('click', (e) => {
        barsMixed = true
        document.getElementById("console").value = ""
        checkButtons(barsMixed, mixbutton, [bubblesortbutton])
        mixBars(numbers)
    })

    /* todo do it right
    stopbutton.addEventListener('click', (e) => {
        worker.terminate()
        worker = new Worker('bubble.js')
    })

     */


    printBars("bars", numbers)
    checkButtons(barsMixed, mixbutton, [bubblesortbutton])
    document.getElementById("console").value = ""

</script>
</body>
</html>